<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>Kymppikaide – Konfiguraattori</title>
  <style>
    body { font-family: Arial, sans-serif; max-width:780px; margin:20px auto;}
    canvas {border: 1px solid #888;}
    #three-canvas { border:1px solid #666; margin-top:10px; border-radius:4px; background: #e6e9ef;}
    .row, .row2 {margin-bottom:15px;}
    .row2 {margin-top:7px;}
    .config-section {background:#f6f6f6; border:1px solid #e0e0e0; border-radius:7px; padding:15px; margin-bottom:15px;}
    .msg {color:green; font-weight:bold;}
    .file-label {margin-right:12px;}
    .info {font-size:0.97em; margin-bottom:14px;}
  </style>
</head>
<body>
  <h2>Kymppikaide – konfiguraattori</h2>
  <div class="config-section">
    <div class="row">
      <b>Kaidemalli:</b>
      <select id="kaidetyyppi"></select>
    </div>
    <div class="row">
      <b>Kaiteen korkeus:</b>
      <select id="kaideKorkeus"></select>
      <input id="customKorkeus" type="number" step="0.01" min="0.8" max="2" placeholder="Syötä korkeus (m)" style="display:none; width:90px;">
    </div>
    <div class="row">
      <b>Käyttökohde:</b>
      <select id="kaytto"></select>
      <span id="zincLabel" style="color:#0a7;">Sinkitys lisätään automaattisesti ulkokäytössä.</span>
    </div>
    <div class="row">
      <b>Väri:</b>
      <select id="color"></select>
      <span id="colorPreview" style="display:inline-block;width:24px;height:17px;margin-left:12px;border:1px solid #888"></span>
    </div>
    <div class="row">
      <b>Kiinnitysmateriaali:</b>
      <select id="material"></select>
      <input id="customMaterial" type="text" placeholder="Muu materiaali" style="display:none;width:120px;">
    </div>
  </div>
  <div class="row2 info">
    <b>Voit liittää PDF- ja kuvatiedostoja tarjouspyyntöön.</b>
    <input type="file" id="attachments" multiple>
    <span id="fileList"></span>
  </div>
  <div class="row2">
    <button id="preview3d">Näytä 3D-esikatselu</button>
  </div>
  <div id="three-area">
    <canvas id="three-canvas" width="600" height="280"></canvas>
  </div>

  <form id="quotationForm">
    <h3>Yhteystiedot</h3>
    <div class="row"><input name="nimi" required placeholder="Nimi" style="width:98%"></div>
    <div class="row"><input name="osoite" required placeholder="Osoite" style="width:98%"></div>
    <div class="row"><input name="puhelin" required placeholder="Puhelinnumero" style="width:98%"></div>
    <div class="row"><input name="email" type="email" required placeholder="Sähköposti" style="width:98%"></div>
    <div class="row">
      <b>Toimitustapa:</b>
      <label><input type="radio" name="toimitus" value="asennus" checked>Asennus (PK-seutu)</label>
      <label><input type="radio" name="toimitus" value="tarvike">Tarviketoimitus</label>
    </div>
    <div class="row"><button type="submit" style="font-size:1.05em;">Lähetä tarjouspyyntö</button>
    <span id="msg" class="msg"></span>
    </div>
  </form>

  <script type="module">
    import { KAIDEMALLIT, KORKEUDET, VARIT, KAYTTO, KIINNITYS, validateFileType, needsZinc, mallidata } from './config.js';

    // --- Valintojen täyttö ---
    function fillSelect(id, items, labelProp="label") {
      const sel=document.getElementById(id);
      items.forEach(val=>{
        let opt=document.createElement('option');
        opt.value=val.id || val;
        opt.innerText=val[labelProp]||val;
        sel.appendChild(opt);
      });
    }
    fillSelect("kaidetyyppi", KAIDEMALLIT, "label");
    fillSelect("kaideKorkeus", KORKEUDET);
    fillSelect("color", VARIT, "label");
    fillSelect("kaytto", KAYTTO);
    fillSelect("material", KIINNITYS);

    // Väri preview
    function updateColor() {
      let c=document.getElementById('color').value;
      let val=VARIT.find(v=>v.id===c)?.code || "#222";
      document.getElementById('colorPreview').style.background=val;
    }
    document.getElementById('color').addEventListener('change', updateColor);
    updateColor();

    // Korkeuden manuaalinen syöttö
    document.getElementById('kaideKorkeus').addEventListener('change', function(e){
      document.getElementById('customKorkeus').style.display = (e.target.value === 'muu') ? 'inline-block' : 'none';
    });
    document.getElementById('material').addEventListener('change', (e)=>{
      document.getElementById('customMaterial').style.display=(e.target.value==='muu')?'inline-block':'none';
    });

    // Sinkitys automaattisesti ulkokäytössä
    function updateZinc() {
      document.getElementById('zincLabel').style.display = (document.getElementById('kaytto').value==='ulkona')?"inline":"none";
    }
    document.getElementById('kaytto').addEventListener('change', updateZinc);
    updateZinc();

    // PDF/kuvaliitteet
    document.getElementById('attachments').addEventListener('change',function(e){
      const files=[...e.target.files];
      let ul = files.map(f => validateFileType(f.name)?`<span class="file-label">${f.name}</span>`:`<span style="color:red">${f.name} (tiedostotyyppi ei tuettu)</span>`).join("");
      document.getElementById('fileList').innerHTML = ul;
    });

    // Lomakkeen lähetys
    document.getElementById('quotationForm').addEventListener('submit', function(e){
      e.preventDefault();
      let fd = new FormData(e.target);
      let data={};
      for(const [k,v] of fd.entries()) data[k]=v;
      let kork=document.getElementById('kaideKorkeus').value;
      if(kork==='muu') kork=document.getElementById('customKorkeus').value;
      data.kaidetyyppi=document.getElementById('kaidetyyppi').value;
      data.kaideKorkeus=kork;
      data.color=document.getElementById('color').value;
      data.material=document.getElementById('material').value==='muu'?document.getElementById('customMaterial').value:document.getElementById('material').value;
      data.kaytto=document.getElementById('kaytto').value;
      data.sinkitys=needsZinc(data.kaytto);
      data.attachments=[...document.getElementById('attachments').files].map(f=>f.name);
      document.getElementById('msg').textContent = "Kiitos tarjouspyynnöstä! (Demo)";
      setTimeout(()=>{document.getElementById('msg').textContent=""}, 3500);
    });

    // ------ 3D-esikatselu pinnakaiteesta (THREE.js mock) ------
    let three_ready=false;
    document.getElementById('preview3d').onclick=function(){
      if(three_ready) return;
      const script=document.createElement('script');
      script.src="https://unpkg.com/three@0.140.0/build/three.min.js";
      script.onload=showKaide3d;
      document.body.appendChild(script);
    };

    function showKaide3d() {
      three_ready=true;
      let canvas=document.getElementById('three-canvas');
      let renderer = new THREE.WebGLRenderer({canvas, antialias:true});
      renderer.setClearColor(0xe6e9ef);

      let scene = new THREE.Scene();
      let camera = new THREE.PerspectiveCamera(45, 600/280, 0.1, 1000);
      camera.position.set(2,1.2,5);

      let ambientLight = new THREE.AmbientLight(0xffffff,1.2);
      scene.add(ambientLight);

      // Mallin parametrit
      let malli_id=document.getElementById('kaidetyyppi').value;
      let model=mallidata(malli_id);
      let height=parseFloat(document.getElementById('kaideKorkeus').value==='muu'?document.getElementById('customKorkeus').value:document.getElementById('kaideKorkeus').value)||1.0;
      let width=2.4; // Demo-kaideleveys (voit vaihtaa frontista)
      let numPinnat=Math.round(width/0.13); // Pinnaväli n. 13cm

      // Ylä-/alalatta
      const lattaGeo=new THREE.BoxGeometry(width,0.04,0.006);
      const lattaMat=new THREE.MeshStandardMaterial({color:0x333333});
      let ylatanko=new THREE.Mesh(lattaGeo, lattaMat);
      ylatanko.position.set(0, height, 0);
      scene.add(ylatanko);

      let alatanko=new THREE.Mesh(lattaGeo, lattaMat);
      alatanko.position.set(0,0,0);
      scene.add(alatanko);

      // Pystypinnat
      const pinnaGeo=new THREE.CylinderGeometry(0.012,0.012,height,16);
      for(let i=0;i<numPinnat;i++) {
        let x=-width/2+0.06+i*0.13;
        let pinna=new THREE.Mesh(pinnaGeo, lattaMat);
        pinna.position.set(x,height/2,0);
        scene.add(pinna);
      }

      renderer.render(scene,camera);
    }
    // ----------- HUOMIO! config.js sisältää ylläpidettävät asetukset -----------
  </script>
</body>
</html>
